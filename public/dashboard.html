<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuraChef - Elysium v2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #E77D22; --light-bg: #FDFCFB; --secondary-bg: #FFFFFF;
            --text-color: #1a1a1a; --text-muted: #888888; --border-color: rgba(0,0,0,0.07);
            --font-primary: 'Playfair Display', serif; --font-secondary: 'Roboto', sans-serif;
            --shadow: 0 4px 15px rgba(0,0,0,0.05); --shadow-lg: 0 10px 40px rgba(0,0,0,0.1);
            --success-color: #28a745; --success-bg: rgba(40, 167, 69, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-secondary); background-color: var(--light-bg);
            color: var(--text-color); height: 100vh; overflow: hidden;
        }
        body.modal-open .page-container { filter: blur(8px) saturate(0.9); transform: scale(0.99); }

        /* --- Main Layout --- */
        .page-container { display: flex; height: 100vh; transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1); }
        .sidebar {
            width: 280px; background-color: var(--secondary-bg); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; padding: 40px 25px; z-index: 10; flex-shrink: 0;
        }
        .main-content { flex-grow: 1; overflow-y: auto; padding: 50px; }
        .view { display: none; }
        .view.active { display: block; animation: viewFadeIn 0.8s ease-out; }
        @keyframes viewFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Sidebar --- */
        .sidebar-header .logo { font-family: var(--font-primary); font-size: 2.2rem; text-decoration: none; color: var(--text-color); }
        .sidebar-header .logo span { color: var(--primary-color); }
        .sidebar-nav { margin-top: 60px; }
        .sidebar-nav .nav-link {
            display: flex; align-items: center; padding: 16px; color: var(--text-muted); text-decoration: none;
            border-radius: 10px; margin-bottom: 12px; transition: all 0.3s ease; font-weight: 500;
        }
        .sidebar-nav .nav-link:hover { background-color: var(--light-bg); color: var(--text-color); }
        .sidebar-nav .nav-link.active { background: linear-gradient(90deg, var(--primary-color) 0%, #FFC371 100%); color: white; box-shadow: 0 5px 15px rgba(231,125,34,0.2); }
        .sidebar-nav .nav-link i { width: 35px; font-size: 1.2rem; }
        .sidebar-footer { margin-top: auto; }
        
        /* --- Dashboard (AC Speak) --- */
        .page-header { margin-bottom: 40px; }
        .page-header h1 { font-family: var(--font-primary); font-size: 3rem; }
        .page-header p { font-size: 1.2rem; color: var(--text-muted); margin-top: 5px; }
        .recipe-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 40px; }
        .recipe-card {
            background: var(--secondary-bg); border-radius: 16px; box-shadow: var(--shadow);
            overflow: hidden; display: flex; flex-direction: column;
            transform-style: preserve-3d; opacity: 0; transform: translateY(40px);
            animation: cardFadeInUp 0.6s ease-out forwards;
        }
        @keyframes cardFadeInUp { to { opacity: 1; transform: translateY(0); } }
        .recipe-card:hover { transform: translateY(-12px) scale(1.03); box-shadow: var(--shadow-lg); }
        .card-image {
            height: 220px; background: linear-gradient(45deg, var(--border-color), var(--light-bg));
            display: flex; align-items: center; justify-content: center;
            color: var(--text-muted); text-align: center; padding: 20px; font-size: 1.2rem;
            font-family: var(--font-primary);
        }
        .card-content { padding: 25px; flex-grow: 1; }
        .card-title { font-family: var(--font-primary); font-size: 1.6rem; margin-bottom: 10px; }
        .card-description { font-size: 1rem; color: var(--text-muted); line-height: 1.6; }
        .card-footer { display: flex; align-items: center; padding: 20px 25px; border-top: 1px solid var(--border-color); }
        .btn { border: none; padding: 14px 28px; font-size: 1rem; font-weight: 700; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary { background: var(--primary-color); color: white; box-shadow: 0 4px 12px rgba(231,125,34,0.2); }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 7px 20px rgba(231,125,34,0.3); }

        /* --- Modal System --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000;
            display: flex; justify-content: flex-end; align-items: center;
            background: rgba(253, 252, 251, 0.5); backdrop-filter: blur(0px);
            opacity: 0; visibility: hidden; transition: all 0.5s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; backdrop-filter: blur(8px); }
        .modal-panel {
            width: 95%; max-width: 900px; height: 95vh; max-height: 850px;
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px);
            border-radius: 20px; border: 1px solid rgba(255,255,255,0.2);
            box-shadow: var(--shadow-lg); display: flex; flex-direction: column;
            transform: translateX(110%); transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1);
            margin-right: 2.5vh;
        }
        .modal-overlay.active .modal-panel { transform: translateX(0); }
        .modal-header { padding: 30px 40px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-family: var(--font-primary); font-size: 2.2rem; }
        .modal-body { flex-grow: 1; padding: 30px 40px; overflow-y: auto; }
        .modal-close-btn { background: none; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer; }
        
        /* --- Fluid Pantry --- */
        .pantry-search-header { display: flex; gap: 20px; margin-bottom: 30px; }
        .pantry-search-header input { flex-grow: 1; padding: 14px; border-radius: 8px; font-size: 1rem; border: 1px solid var(--border-color); background-color: white; }
        .pantry-category { margin-bottom: 30px; }
        .pantry-category-title { font-family: var(--font-primary); font-size: 1.4rem; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .ingredient-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; }
        .ingredient-chip {
            padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; text-align: center; cursor: pointer; 
            transition: all 0.3s ease; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .ingredient-chip:hover { transform: translateY(-3px); box-shadow: var(--shadow); }
        .ingredient-chip.selected { background-color: var(--primary-color); color: white; border-color: var(--primary-color); font-weight: 700; }
        .ingredient-chip .fa-check { display: none; }
        .ingredient-chip.selected .fa-check { display: inline-block; }
        #savePantryBtn { background-color: var(--success-color); box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2); }
        #savePantryBtn:hover { transform: translateY(-3px); box-shadow: 0 7px 20px rgba(40, 167, 69, 0.3); }
        #savePantryBtn.saved { background: var(--success-bg); color: var(--success-color); }
        #savePantryBtn.saved i { margin-right: 8px; }

        /* --- Guided Cooking Cinematic Modal --- */
        .guided-cook-modal .modal-panel { max-width: 800px; height: 80vh; max-height: 700px; }
        .guided-cook-body { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 40px; }
        .cooking-animation { font-size: 5rem; color: var(--primary-color); margin-bottom: 30px; }
        .cooking-animation i { animation: beat 1.5s infinite ease-in-out; }
        @keyframes beat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .step-instruction { font-size: 1.8rem; line-height: 1.6; font-weight: 300; }
        .guided-cook-footer { padding: 30px 40px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .step-counter { color: var(--text-muted); font-weight: 500; }
        .final-step-message { text-align: center; }
        .final-step-message i { font-size: 6rem; color: var(--success-color); animation: tada 1s ease; }
        @keyframes tada { from { transform: scale3d(1, 1, 1); } 10%, 20% { transform: scale3d(.9, .9, .9) rotate3d(0, 0, 1, -3deg); } 30%, 50%, 70%, 90% { transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, 3deg); } 40%, 60%, 80% { transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, -3deg); } to { transform: scale3d(1, 1, 1); } }
        .final-step-message h2 { font-family: var(--font-primary); font-size: 2.5rem; margin-top: 20px; }
        /* --- Detail Modal & Timer --- */
        #recipeDetailModal .modal-panel { max-width: 780px; }
        .detail-meta { display:flex; flex-wrap:wrap; gap:14px; margin:20px 0; }
        .detail-meta span { background:var(--light-bg); padding:6px 12px; border-radius:20px; font-size:.85rem; border:1px solid var(--border-color); }
        .nutrition-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:14px; margin-top:20px; }
        .nutrition-item { background:#fff; border:1px solid var(--border-color); border-radius:12px; padding:10px 12px; text-align:center; font-size:.85rem; }
        .nutrition-item strong { display:block; font-size:.75rem; color:var(--text-muted); font-weight:500; }
        .timer-circle { position:relative; width:150px; height:150px; margin:25px auto 10px; }
        .timer-circle svg { width:150px; height:150px; transform:rotate(-90deg); }
        .timer-circle .time-display { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:1.5rem; font-weight:700; }
        .step-instruction.with-timer { margin-top:10px; }
    </style>
</head>
<body>

    <div class="page-container">
        <aside class="sidebar">
            <div class="sidebar-header"><a href="#" class="logo">Aura<span>Chef</span></a></div>
            <nav class="sidebar-nav">
                <a href="#dashboard" class="nav-link active" data-view="dashboardView"><i class="fas fa-utensils"></i> AC Speak</a>
                <a href="AC_Agent.html" class="nav-link"><i class="fas fa-robot"></i> AC Agent</a>
                <a href="#pantry" class="nav-link" data-modal="pantryModal"><i class="fas fa-carrot"></i> My Pantry</a>
                <a href="#settings" class="nav-link" data-modal="settingsModal"><i class="fas fa-cog"></i> Account</a>
            </nav>
            <footer class="sidebar-footer">
                <a href="#" class="nav-link" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </footer>
        </aside>

        <main class="main-content">
            <div id="dashboardView" class="view active">
                <header class="page-header">
                    <h1 id="welcomeMessage">Welcome, Chef!</h1>
                    <p>Your Daily Prep, crafted from your kitchen's potential.</p>
                    <button id="cookNowBtn" class="btn btn-primary" style="margin-top:20px;">
                        <i class="fas fa-fire"></i> Cook Now
                    </button>
                </header>
                <div class="recipe-grid" id="recipeGrid"></div>
            </div>
        </main>
    </div>

    <!-- MODAL: Pantry Manager -->
    <div class="modal-overlay" id="pantryModal">
        <div class="modal-panel">
            <div class="modal-header" style="align-items:center; gap:16px;">
                <h2 style="flex:1;">My Digital Pantry</h2>
                <button class="modal-close-btn" data-close-modal aria-label="Close Pantry"><i class="fas fa-times"></i></button>
                <button class="btn btn-primary" id="savePantryBtn"><i class="fas fa-save"></i> Save & Refresh</button>
            </div>
            <div class="modal-body">
                <div class="pantry-search-header">
                    <input type="text" id="pantrySearchInput" placeholder="Search for an ingredient to quickly find it...">
                </div>
                <div id="pantryCategories"></div>
            </div>
        </div>
    </div>
    
    <!-- MODAL: Account Settings -->
    <div class="modal-overlay" id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
        <div class="modal-panel">
             <div class="modal-header" style="justify-content:space-between;align-items:center;">
                <h2 id="settingsTitle">Account Settings</h2>
                <button class="modal-close-btn" data-close-modal aria-label="Close settings"><i class="fas fa-times"></i></button>
             </div>
             <div class="modal-body">
                <form id="accountSettingsForm" style="max-width:520px;display:flex;flex-direction:column;gap:18px;">
                    <div>
                        <label for="currentEmail" style="font-weight:600;display:block;margin-bottom:6px;">Current Email</label>
                        <input id="currentEmail" type="email" disabled style="width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;background:#fafafa;" />
                    </div>
                    <div>
                        <label for="newEmail" style="font-weight:600;display:block;margin-bottom:6px;">New Email (optional)</label>
                        <input id="newEmail" type="email" placeholder="Enter new email" style="width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;" />
                    </div>
                    <div style="display:flex;gap:16px;flex-wrap:wrap;">
                        <div style="flex:1;min-width:220px;">
                            <label for="newPassword" style="font-weight:600;display:block;margin-bottom:6px;">New Password (optional)</label>
                            <input id="newPassword" type="password" placeholder="Min 6 characters" style="width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;" />
                        </div>
                        <div style="flex:1;min-width:220px;">
                            <label for="confirmPassword" style="font-weight:600;display:block;margin-bottom:6px;">Confirm Password</label>
                            <input id="confirmPassword" type="password" placeholder="Retype password" style="width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;" />
                        </div>
                    </div>
                    <div id="settingsFeedback" aria-live="polite" style="min-height:24px;font-size:.9rem;"></div>
                    <button id="saveAccountBtn" type="submit" class="btn btn-primary" style="align-self:flex-start;">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </form>
             </div>
        </div>
    </div>

    <!-- MODAL: Guided Cooking -->
    <div class="modal-overlay guided-cook-modal" id="guidedCookModal" role="dialog" aria-modal="true" aria-labelledby="guidedCookTitle">
        <div class="modal-panel">
            <div class="modal-header"><h2 id="guidedCookTitle"></h2></div>
            <div class="guided-cook-body" id="guidedCookBody">
                <!-- Content injected by JS -->
            </div>
            <div class="guided-cook-footer" id="guidedCookFooter">
                <span class="step-counter" id="stepCounterDisplay"></span>
                <button class="btn btn-primary" id="pauseStepBtn" style="background:#555;" aria-label="Pause step timer" hidden></button>
                <button class="btn btn-primary" id="skipStepBtn" aria-label="Skip current step" style="background:#999;">Skip Step</button>
                <button class="btn btn-primary" id="nextStepBtn" aria-label="Advance to next step"></button>
            </div>
        </div>
    </div>

    <!-- MODAL: Recipe Detail -->
    <div class="modal-overlay" id="recipeDetailModal" role="dialog" aria-modal="true" aria-labelledby="recipeDetailTitle">
        <div class="modal-panel">
            <div class="modal-header">
                <h2 id="recipeDetailTitle"></h2>
                <button class="modal-close-btn" data-close-modal><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="recipeDetailBody">
                <!-- Filled dynamically -->
            </div>
        </div>
    </div>

    <script>
    // --- State, Constants & Cache ---
    const appState = {
        user: null, recipes: [], pantry: [], pantryDirty: false, activeModal: null,
        cooking: { recipe: null, step: 0, timer: null, remaining: 0, total: 0, paused: false }
    };
    let cookingInterval = null; // timer interval reference
    // Robust token extraction with diagnostics
    let token = null;
    try {
        const rawUser = localStorage.getItem('auraChefUser');
        if (rawUser) {
            const parsed = JSON.parse(rawUser);
            token = parsed?.token || null;
        } else {
            console.warn('[Dashboard] No auraChefUser found in localStorage');
        }
    } catch (ex) {
        console.error('[Dashboard] Failed to parse auraChefUser localStorage entry:', ex.message);
    }
    const API_HEADERS = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
    const DOMElements = { /* Cached elements */ };
    const MASTER_INGREDIENT_LIST = {
        "Proteins": ["chicken","egg","paneer","tofu","lentils","chickpeas","fish","prawns","dal","beans"],
        "Vegetables": ["onion","tomato","garlic","ginger","potato","carrot","capsicum","spinach","cabbage","cauliflower","broccoli","green peas","okra"],
        "Fruits": ["apple","banana","mango","orange","grapes","pineapple","papaya","avocado","lemon","lime"],
        "Grains & Cereals": ["rice","wheat flour","maida","oats","quinoa","poha","semolina","millet"],
        "Dairy": ["milk","curd","butter","cheese","ghee","cream"],
        "Spices & Herbs": ["turmeric","cumin","coriander","garam masala","chilli powder","black pepper","cardamom","clove","mustard seeds","fenugreek","bay leaf","curry leaves","mint","cilantro"],
        "Oils & Sauces": ["oil","olive oil","soy sauce","vinegar","sesame oil","tomato ketchup"],
        "Baking & Pantry": ["salt","sugar","brown sugar","baking powder","baking soda","corn flour","yeast"],
        "Nuts & Seeds": ["cashew","almond","peanut","walnut","sesame","flaxseed","chia"],
        "Misc": ["coconut","jaggery","honey"]
    };
    
    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        if (!token) { window.location.href = '/index.html'; return; }
        cacheDOMElements();
        setupEventListeners();
        initializeApp();
    });

    async function initializeApp() {
        renderSkeletonLoader();
        try {
            const res = await fetch('/api/users/profile', { headers: API_HEADERS });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.message || `Failed to load profile (${res.status})`);
            }
            const userProfile = await res.json();
            appState.user = userProfile || {};
            appState.pantry = Array.isArray(userProfile?.pantry) ? [...userProfile.pantry] : [];
            const firstName = (appState.user?.name || 'Chef').split(' ')[0];
            if (DOMElements.welcomeMessage) DOMElements.welcomeMessage.textContent = `Welcome, ${firstName}!`;
            // Do NOT auto-fetch recipes; user triggers via Cook Now.
            DOMElements.recipeGrid.innerHTML = `<h3 style="opacity:.8;">Ready when you are. Press <strong>Cook Now</strong> to generate fresh recipes from your pantry.</h3>`;
        } catch (error) {
            console.error('Dashboard init error:', error);
            if (DOMElements.recipeGrid) DOMElements.recipeGrid.innerHTML = `<p>Error loading dashboard. ${error.message}</p>`;
        }
    }

    // --- API & DATA ---
    async function fetchAndRenderRecipes() {
        console.log('[Dashboard] Initiating recipe fetch...');
        if (!token) {
            DOMElements.recipeGrid.innerHTML = '<h3>Missing authentication token. Please log in again.</h3>';
            return;
        }
        renderSkeletonLoader();
        try {
            const response = await fetch('/api/recipes/generate', { headers: API_HEADERS });
            const contentType = response.headers.get('content-type') || '';
            console.log('[Dashboard] /api/recipes/generate status:', response.status, 'content-type:', contentType);
            if (!response.ok) {
                // Attempt to parse JSON error else fallback to text
                let serverMsg = `HTTP ${response.status}`;
                if (contentType.includes('application/json')) {
                    try { const errJson = await response.json(); serverMsg = errJson.message || serverMsg; } catch {}
                } else {
                    const rawText = await response.text();
                    serverMsg = `Non-JSON error response (${response.status}). First 120 chars: ${rawText.slice(0,120)}`;
                }
                throw new Error(serverMsg);
            }
            if (!contentType.includes('application/json')) {
                const raw = await response.text();
                throw new Error(`Expected JSON but received '${contentType}'. Preview: ${raw.slice(0,120)}`);
            }
            const rawJson = await response.json();
            if (!Array.isArray(rawJson)) {
                console.warn('[Dashboard] Response JSON not an array:', rawJson);
                if (rawJson && rawJson.message) {
                    throw new Error(`Server message: ${rawJson.message}`);
                }
                throw new Error('Unexpected response shape from API');
            }
            appState.recipes = rawJson.map(r => {
                if (!r.nutritionalInfo && (r['Nutritonal Information'] || r['Nutritional Information'])) {
                    r.nutritionalInfo = r['Nutritonal Information'] || r['Nutritional Information'];
                }
                return r;
            });
            console.log('[Dashboard] Parsed recipes count:', appState.recipes.length);
            renderDashboard();
        } catch (e) {
            console.error('[Dashboard] Recipe fetch error:', e);
            if (DOMElements.recipeGrid) {
                DOMElements.recipeGrid.innerHTML = `<div style="padding:20px;border:1px solid #e0b096;border-radius:12px;background:#fff5ef;color:#b34d00;">`+
                    `<h3 style='margin-bottom:8px;'>Recipe Generation Failed</h3>`+
                    `<p style='margin:0;font-size:.9rem;line-height:1.4;'>${e.message}</p>`+
                    `<button id='retryFetchBtn' style='margin-top:14px;background:#E77D22;color:#fff;border:none;padding:10px 18px;border-radius:8px;cursor:pointer;font-weight:600;'>Retry</button>`+
                    `<p style='margin-top:10px;font-size:.75rem;opacity:.65;'>Check server logs for [Gemini Request] and [Gemini Response]. If parsing keeps failing, verify API key/model or reduce temperature.</p>`+
                    `</div>`;
                const retryBtn = document.getElementById('retryFetchBtn');
                if (retryBtn) retryBtn.addEventListener('click', fetchAndRenderRecipes);
            }
        }
    }
    
    async function savePantry() {
        const saveBtn = DOMElements.savePantryBtn;
        saveBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Saving...`;
        saveBtn.disabled = true;

        await fetch('/api/users/pantry', { method: 'PUT', headers: API_HEADERS, body: JSON.stringify({ pantry: appState.pantry }) });
        
        saveBtn.innerHTML = `<i class="fas fa-check"></i> Saved!`;
        saveBtn.classList.add('saved');
        
        setTimeout(() => {
            saveBtn.innerHTML = `<i class="fas fa-save"></i> Save & Refresh`;
            saveBtn.classList.remove('saved');
            saveBtn.disabled = false;
            handleCloseModal();
            fetchAndRenderRecipes();
        }, 1500);

        appState.pantryDirty = false;
    }

    // --- RENDERING ---
    function render() {
        // Master render function for modals
        const modalToOpen = appState.activeModal;
        document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
        DOMElements.body.classList.remove('modal-open');

        if (modalToOpen) {
            document.getElementById(modalToOpen).classList.add('active');
            DOMElements.body.classList.add('modal-open');
            if (modalToOpen === 'pantryModal') renderPantry();
            if (modalToOpen === 'settingsModal') populateSettingsForm();
        }
    }
    
    function renderDashboard() {
        DOMElements.recipeGrid.innerHTML = '';
        if (appState.recipes.length === 0) {
            DOMElements.recipeGrid.innerHTML = `<h3>Your pantry is awaiting inspiration! Add ingredients to discover recipes.</h3>`; return;
        }
        appState.recipes.forEach((recipe, index) => {
            const card = document.createElement('div');
            card.className = 'recipe-card';
            card.dataset.recipeId = recipe.id;
            card.style.animationDelay = `${index * 65}ms`;
            const imgUrl = (typeof recipe.image === 'string' && /^https?:\/\//i.test(recipe.image)) ? recipe.image : null;
            const imageMarkup = imgUrl ? `<img src="${imgUrl}" alt="${recipe.title}" style="width:100%;height:100%;object-fit:cover;" onerror="this.parentElement.innerHTML='<span style=\'font-size:1rem;opacity:.7;\'>${recipe.title}</span>'">` : `<span style="font-size:1rem;opacity:.7;">${recipe.title}</span>`;
            card.innerHTML = `
                <div class="card-image">${imageMarkup}</div>
                <div class="card-content">
                    <h2 class="card-title">${recipe.title}</h2>
                    <p class="card-description">${recipe.description}</p>
                </div>
                <div class="card-footer" style="justify-content:space-between;gap:12px;">
                    <button class="btn btn-primary view-detail-btn" style="flex:1"><i class="fas fa-eye"></i> Details</button>
                    <button class="btn btn-primary cook-now-btn" style="flex:1"><i class="fas fa-play"></i> Start Cooking</button>
                </div>`;
            DOMElements.recipeGrid.appendChild(card);
        });
    }

    function renderPantry(searchTerm = '') {
        let content = '';
        for (const category in MASTER_INGREDIENT_LIST) {
            const filteredItems = MASTER_INGREDIENT_LIST[category].filter(item => item.toLowerCase().includes(searchTerm.toLowerCase()));
            if(filteredItems.length === 0) continue;
            content += `<div class="pantry-category">
                <h3 class="pantry-category-title">${category}</h3>
                <div class="ingredient-grid">
                    ${filteredItems.map(item => `
                        <div class="ingredient-chip ${appState.pantry.includes(item) ? 'selected' : ''}" data-ingredient="${item}">
                            <i class="fas fa-check"></i> ${item}
                        </div>
                    `).join('')}
                </div>
            </div>`;
        }
        DOMElements.pantryCategories.innerHTML = content;
    }

    function renderGuidedCookingStep() {
        const recipe = appState.cooking.recipe;
        const stepIndex = appState.cooking.step;
        const totalSteps = recipe.steps.length;

        DOMElements.guidedCookTitle.textContent = recipe.title;

        if (stepIndex >= totalSteps) { // Cooking finished
            DOMElements.guidedCookBody.innerHTML = `
                <div class="final-step-message">
                    <i class="fas fa-trophy"></i>
                    <h2>Cooking Complete!</h2>
                    <p style="margin-top: 10px; color: var(--text-muted);">It's irresistibly tasty! üòãüçΩÔ∏è</p>
                </div>`;
            DOMElements.guidedCookFooter.style.display = 'none';
            clearInterval(cookingInterval);
            resetCookingState();
            setTimeout(handleCloseModal, 3000); // Auto-close after 3s
        } else {
            const step = recipe.steps[stepIndex];
            const durationSeconds = parseStepDuration(step);
            DOMElements.guidedCookBody.innerHTML = `
                <div class="cooking-animation"><i class="fas fa-utensils"></i></div>
                <div id="timerContainer"></div>
                <p class="step-instruction ${durationSeconds ? 'with-timer' : ''}" aria-live="polite">${step}</p>`;
            DOMElements.guidedCookFooter.style.display = 'flex';
            DOMElements.stepCounterDisplay.textContent = `Step ${stepIndex + 1} / ${totalSteps}`;
            if (durationSeconds) {
                startStepTimer(durationSeconds, stepIndex === totalSteps - 1 ? 'Finish!' : 'Complete Step');
            } else {
                DOMElements.nextStepBtn.disabled = false;
                DOMElements.nextStepBtn.textContent = stepIndex === totalSteps - 1 ? 'Finish!' : 'Next Step';
                DOMElements.pauseStepBtn.hidden = true;
                // Skip is still available for manual advance
            }
        }
    }

    // --- EVENT HANDLING & NAVIGATION ---
    function setupEventListeners() {
        document.addEventListener('click', e => {
            const navLink = e.target.closest('.nav-link');
            const closeModalBtn = e.target.closest('[data-close-modal]');
            const overlay = e.target.closest('.modal-overlay');
            const ingredientChip = e.target.closest('.ingredient-chip');
            const cookNowBtn = e.target.closest('.cook-now-btn');
            const detailBtn = e.target.closest('.view-detail-btn');

            if (navLink) { e.preventDefault(); handleNavClick(navLink); }
            else if (closeModalBtn || (overlay && !overlay.querySelector('.modal-panel').contains(e.target))) { handleCloseModal(); }
            else if (ingredientChip) { handlePantryUpdate(ingredientChip.dataset.ingredient); }
            else if (cookNowBtn) { startGuidedCooking(cookNowBtn.closest('.recipe-card').dataset.recipeId); }
            else if (detailBtn) { openRecipeDetail(detailBtn.closest('.recipe-card').dataset.recipeId); }
        });
        
        if (DOMElements.pantrySearchInput) DOMElements.pantrySearchInput.addEventListener('input', e => renderPantry(e.target.value));
        if (DOMElements.savePantryBtn) DOMElements.savePantryBtn.addEventListener('click', savePantry);
        if (DOMElements.logoutBtn) DOMElements.logoutBtn.addEventListener('click', () => { localStorage.removeItem('auraChefUser'); window.location.href = '/index.html'; });
        if (DOMElements.nextStepBtn) DOMElements.nextStepBtn.addEventListener('click', () => {
            if (appState.cooking.paused) return; // do not advance while paused
            appState.cooking.step++;
            renderGuidedCookingStep();
        });
        if (DOMElements.pauseStepBtn) DOMElements.pauseStepBtn.addEventListener('click', togglePauseTimer);
        if (DOMElements.skipStepBtn) DOMElements.skipStepBtn.addEventListener('click', () => {
            clearInterval(cookingInterval);
            appState.cooking.step++;
            renderGuidedCookingStep();
        });
        const cookNowBtn = document.getElementById('cookNowBtn');
        if (cookNowBtn) cookNowBtn.addEventListener('click', () => {
            fetchAndRenderRecipes();
        });
    }

    function handleNavClick(navLink) {
        if (navLink.href.endsWith('AC_Agent.html')) { window.location.href = 'AC_Agent.html'; return; }
        
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        navLink.classList.add('active');
        const modalTarget = navLink.dataset.modal;
        
        if (modalTarget) {
            appState.activeModal = (appState.activeModal === modalTarget) ? null : modalTarget;
            render();
        } else {
            if (appState.activeModal) handleCloseModal();
            if (navLink.getAttribute('href') === '#dashboard') fetchAndRenderRecipes();
        }
    }

    function handleCloseModal() {
        if (appState.activeModal === 'pantryModal' && appState.pantryDirty) { savePantry(); }
        if (appState.activeModal === 'guidedCookModal') { clearInterval(cookingInterval); resetCookingState(); }
        appState.activeModal = null;
        render();
    }
    
    function handlePantryUpdate(ingredient) {
        const chip = document.querySelector(`.ingredient-chip[data-ingredient="${ingredient}"]`);
        const isSelected = appState.pantry.includes(ingredient);
        if (isSelected) {
            appState.pantry = appState.pantry.filter(i => i !== ingredient);
        } else {
            appState.pantry.push(ingredient);
        }
        chip.classList.toggle('selected');
        appState.pantryDirty = true;
    }
    
    function startGuidedCooking(recipeId) {
        clearInterval(cookingInterval);
        appState.cooking.recipe = appState.recipes.find(r => r.id == recipeId);
        appState.cooking.step = 0;
        appState.cooking.remaining = 0;
        appState.cooking.total = 0;
        appState.cooking.paused = false;
        appState.activeModal = 'guidedCookModal';
        render();
        renderGuidedCookingStep();
    }

    function openRecipeDetail(recipeId) {
        const recipe = appState.recipes.find(r => r.id == recipeId);
        if (!recipe) return;
        appState.activeModal = 'recipeDetailModal';
        render();
        DOMElements.recipeDetailTitle.textContent = recipe.title;
        // Build ingredients (fallback: infer from pantry and text if not present)
        let ingredientsList = [];
        if (Array.isArray(recipe.ingredients) && recipe.ingredients.length) {
            ingredientsList = recipe.ingredients;
        } else {
            const hay = `${recipe.title} ${Array.isArray(recipe.steps) ? recipe.steps.join(' ') : ''}`.toLowerCase();
            ingredientsList = (appState.pantry || []).filter(p => hay.includes(p.toLowerCase()));
            if (ingredientsList.length === 0) {
                ingredientsList = (appState.pantry || []).slice(0, 8); // best-effort fallback
            }
        }
        const ingredientsHTML = ingredientsList.map(i => `<li>${i}</li>`).join('');
        const stepsHTML = Array.isArray(recipe.steps) ? recipe.steps.map((s,idx) => `<li><strong>Step ${idx+1}:</strong> ${s}</li>`).join('') : '<li>Not available</li>';
        // Build nutrition grid from object or parse string
        let nutritionGrid = '';
        const rawNutrition = recipe.nutritionalInfo || recipe['Nutritonal Information'] || recipe['Nutritional Information'];
        if (rawNutrition) {
            const parsed = typeof rawNutrition === 'string' ? parseNutritionString(rawNutrition) : rawNutrition;
            if (parsed && typeof parsed === 'object') {
                nutritionGrid = Object.entries(parsed).map(([k,v]) => `<div class="nutrition-item"><strong>${k}</strong>${v}</div>`).join('');
            }
        }
        DOMElements.recipeDetailBody.innerHTML = `
            <p style="color:var(--text-muted);">${recipe.description || ''}</p>
            <div class="detail-meta">
                <span><i class="fas fa-utensils"></i> ${Array.isArray(recipe.ingredients) ? recipe.ingredients.length : 0} ingredients</span>
                <span><i class="fas fa-list-ol"></i> ${Array.isArray(recipe.steps) ? recipe.steps.length : 0} steps</span>
            </div>
            <h3>Ingredients</h3>
            <ul style="margin-left:18px;margin-top:8px;line-height:1.5;">${ingredientsHTML || '<li>Not available</li>'}</ul>
            <h3 style="margin-top:25px;">Steps</h3>
            <ol style="margin-left:18px;margin-top:8px;line-height:1.6;">${stepsHTML}</ol>
            ${nutritionGrid ? `<h3 style=\"margin-top:25px;\">Nutritional Info</h3><div class=\"nutrition-grid\">${nutritionGrid}</div>` : ''}
        `;
    }

    function parseNutritionString(text) {
        // Accept formats like "Calories: 400, Protein: 35g, Carbs: 10g, Fat: 20g"
        const obj = {};
        if (typeof text !== 'string') return obj;
        text.split(/[,;]+/).forEach(part => {
            const [k, v] = part.split(/:\s*/);
            if (k && v) {
                const key = k.trim();
                const val = v.trim();
                if (key) obj[key] = val;
            }
        });
        return obj;
    }

    function parseStepDuration(stepText) {
        // Match patterns like 'for 5 minutes', 'cook 10 min', 'bake 30 mins', 'for 45 seconds'
        const regex = /(\b\d{1,3})\s*(minute|minutes|min|second|seconds|sec)\b/i;
        const match = stepText.match(regex);
        if (!match) return null;
        const value = parseInt(match[1], 10);
        const unit = match[2].toLowerCase();
        if (['second','seconds','sec'].includes(unit)) return value; // seconds
        return value * 60; // minutes to seconds
    }

    function startStepTimer(seconds, nextLabel) {
        clearInterval(cookingInterval);
        DOMElements.nextStepBtn.disabled = true;
        DOMElements.nextStepBtn.textContent = 'Waiting...';
        DOMElements.pauseStepBtn.hidden = false;
        DOMElements.pauseStepBtn.disabled = false;
        DOMElements.pauseStepBtn.textContent = 'Pause';
        appState.cooking.remaining = seconds;
        appState.cooking.total = seconds;
        appState.cooking.paused = false;
        const circumference = 2 * Math.PI * 65; // radius 65
        const timerContainer = document.getElementById('timerContainer');
        timerContainer.innerHTML = `
            <div class="timer-circle">
                <svg>
                    <circle cx="75" cy="75" r="65" stroke="#eee" stroke-width="10" fill="none"></circle>
                    <circle id="timerProgress" cx="75" cy="75" r="65" stroke="var(--primary-color)" stroke-width="10" fill="none" stroke-dasharray="${circumference}" stroke-dashoffset="${circumference}" stroke-linecap="round"></circle>
                </svg>
                <div class="time-display" id="timeDisplay"></div>
            </div>`;
        let remaining = seconds;
        const progressCircle = document.getElementById('timerProgress');
        const timeDisplay = document.getElementById('timeDisplay');
        function tick() {
            if (appState.cooking.paused) return;
            const ratio = (seconds - remaining) / seconds;
            progressCircle.style.strokeDashoffset = circumference * (1 - ratio);
            const mins = Math.floor(remaining / 60);
            const secs = remaining % 60;
            timeDisplay.textContent = mins > 0 ? `${mins}:${secs.toString().padStart(2,'0')}` : `${secs}s`;
            remaining--;
            appState.cooking.remaining = remaining;
            if (remaining < 0) {
                clearInterval(cookingInterval);
                timeDisplay.textContent = 'Done';
                DOMElements.nextStepBtn.disabled = false;
                DOMElements.nextStepBtn.textContent = nextLabel;
                DOMElements.pauseStepBtn.hidden = true;
            }
        }
        tick();
        cookingInterval = setInterval(tick, 1000);
    }

    function togglePauseTimer() {
        if (appState.cooking.remaining <= 0) return;
        appState.cooking.paused = !appState.cooking.paused;
        if (appState.cooking.paused) {
            DOMElements.pauseStepBtn.textContent = 'Resume';
            DOMElements.pauseStepBtn.setAttribute('aria-label','Resume step timer');
        } else {
            DOMElements.pauseStepBtn.textContent = 'Pause';
            DOMElements.pauseStepBtn.setAttribute('aria-label','Pause step timer');
        }
    }

    function resetCookingState() {
        appState.cooking.recipe = null;
        appState.cooking.step = 0;
        appState.cooking.timer = null;
        appState.cooking.remaining = 0;
        appState.cooking.total = 0;
        appState.cooking.paused = false;
    }
    
    // --- UTILITIES ---
    function cacheDOMElements() {
        DOMElements.body = document.body;
        DOMElements.welcomeMessage = document.getElementById('welcomeMessage');
        DOMElements.recipeGrid = document.getElementById('recipeGrid');
        DOMElements.pantryCategories = document.getElementById('pantryCategories');
        DOMElements.pantrySearchInput = document.getElementById('pantrySearchInput');
        DOMElements.savePantryBtn = document.getElementById('savePantryBtn');
        DOMElements.logoutBtn = document.getElementById('logoutBtn');
        DOMElements.guidedCookModal = document.getElementById('guidedCookModal');
        DOMElements.guidedCookTitle = document.getElementById('guidedCookTitle');
        DOMElements.guidedCookBody = document.getElementById('guidedCookBody');
        DOMElements.guidedCookFooter = document.getElementById('guidedCookFooter');
        DOMElements.stepCounterDisplay = document.getElementById('stepCounterDisplay');
        DOMElements.nextStepBtn = document.getElementById('nextStepBtn');
        DOMElements.pauseStepBtn = document.getElementById('pauseStepBtn');
        DOMElements.skipStepBtn = document.getElementById('skipStepBtn');
        DOMElements.recipeDetailModal = document.getElementById('recipeDetailModal');
        DOMElements.recipeDetailTitle = document.getElementById('recipeDetailTitle');
        DOMElements.recipeDetailBody = document.getElementById('recipeDetailBody');
        DOMElements.settingsModal = document.getElementById('settingsModal');
        DOMElements.accountSettingsForm = document.getElementById('accountSettingsForm');
        DOMElements.currentEmail = document.getElementById('currentEmail');
        DOMElements.newEmail = document.getElementById('newEmail');
        DOMElements.newPassword = document.getElementById('newPassword');
        DOMElements.confirmPassword = document.getElementById('confirmPassword');
        DOMElements.settingsFeedback = document.getElementById('settingsFeedback');
        DOMElements.saveAccountBtn = document.getElementById('saveAccountBtn');
    }

    // --- Skeleton Loader ---
    function renderSkeletonLoader() {
        if (!DOMElements.recipeGrid) return;
        const skeletonCard = (i) => `
            <div class="recipe-card" style="animation-delay:${i * 80}ms">
                <div class="card-image" style="background:linear-gradient(90deg,#eee,#f6f6f6,#eee);height:220px"></div>
                <div class="card-content">
                    <div style="height:22px;width:70%;background:#eee;border-radius:6px;margin-bottom:12px"></div>
                    <div style="height:14px;width:100%;background:#f0f0f0;border-radius:6px;margin-bottom:8px"></div>
                    <div style="height:14px;width:90%;background:#f0f0f0;border-radius:6px"></div>
                </div>
                <div class="card-footer">
                    <div style="height:40px;width:140px;background:#eee;border-radius:8px"></div>
                </div>
            </div>`;
        DOMElements.recipeGrid.innerHTML = Array.from({ length: 6 }).map((_, i) => skeletonCard(i)).join('');
    }
    
    const masterIngredientListKeys = Object.keys(MASTER_INGREDIENT_LIST);
    for (const key of masterIngredientListKeys) {
        MASTER_INGREDIENT_LIST[key].sort();
    }

    // --- Account Settings ---
    function populateSettingsForm() {
        if (!DOMElements.currentEmail) return;
        DOMElements.currentEmail.value = appState.user?.email || '';
        DOMElements.newEmail.value = '';
        DOMElements.newPassword.value = '';
        DOMElements.confirmPassword.value = '';
        DOMElements.settingsFeedback.textContent = '';
    }

    if (DOMElements.accountSettingsForm) {
        DOMElements.accountSettingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!appState.user) return;
            const newEmail = DOMElements.newEmail.value.trim();
            const newPassword = DOMElements.newPassword.value;
            const confirmPassword = DOMElements.confirmPassword.value;

            // Validation
            if (newPassword && newPassword !== confirmPassword) {
                DOMElements.settingsFeedback.style.color = 'red';
                DOMElements.settingsFeedback.textContent = 'Passwords do not match';
                return;
            }
            if (newEmail && !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(newEmail)) {
                DOMElements.settingsFeedback.style.color = 'red';
                DOMElements.settingsFeedback.textContent = 'Invalid email format';
                return;
            }
            if (!newEmail && !newPassword) {
                DOMElements.settingsFeedback.style.color = 'red';
                DOMElements.settingsFeedback.textContent = 'No changes to save';
                return;
            }

            DOMElements.saveAccountBtn.disabled = true;
            DOMElements.saveAccountBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            DOMElements.settingsFeedback.textContent = '';

            try {
                const body = {};
                if (newEmail) body.email = newEmail;
                if (newPassword) body.password = newPassword;
                const resp = await fetch('/api/users/profile', { method: 'PUT', headers: API_HEADERS, body: JSON.stringify(body) });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.message || 'Update failed');

                // Update local state & storage
                appState.user.email = data.email;
                if (data.token) {
                    const stored = JSON.parse(localStorage.getItem('auraChefUser')) || {};
                    stored.email = data.email;
                    stored.token = data.token;
                    localStorage.setItem('auraChefUser', JSON.stringify(stored));
                }
                populateSettingsForm();
                DOMElements.settingsFeedback.style.color = 'green';
                DOMElements.settingsFeedback.textContent = 'Profile updated successfully';
            } catch (err) {
                DOMElements.settingsFeedback.style.color = 'red';
                DOMElements.settingsFeedback.textContent = err.message;
            } finally {
                DOMElements.saveAccountBtn.disabled = false;
                DOMElements.saveAccountBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
            }
        });
    }
    </script>
</body>
</html>